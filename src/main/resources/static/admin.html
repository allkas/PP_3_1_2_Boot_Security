<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="_csrf" content="${_csrf.token}">
  <meta name="_csrf_header" content="${_csrf.headerName}">
  <title>Admin Panel</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

</head>
<body>

<!-- Навбар -->
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
        <span class="navbar-text text-white font-weight-bold">
            <span id="currentUserEmail"></span> with roles: <span id="currentUserRoles"></span>
        </span>
    <form action="/logout" method="post">
      <button type="submit" class="btn btn-outline-light">Logout</button>
    </form>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <!-- Боковое меню -->
    <nav class="col-2 sidebar px-0 pt-3">
      <div class="sidebar-sticky">
        <ul class="nav nav-pills flex-column">
          <li class="nav-item">
            <a class="nav-link active" href="/admin.html">Admin</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/user.html">User</a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Основной контент -->
    <main role="main" class="col-md-10 ml-sm-auto px-4">
      <h2 class="mt-4">Admin Panel</h2>

      <!-- Вкладки -->
      <ul class="nav nav-tabs mt-3">
        <li class="nav-item">
          <a class="nav-link active" data-toggle="tab" href="#usersTable">Users Table</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="tab" href="#newUser">New User</a>
        </li>
      </ul>

      <div class="tab-content">
        <!-- Таблица пользователей -->
        <div id="usersTable" class="tab-pane fade show active mt-3">
          <div class="card">
            <div class="card-header">
              All Users
            </div>
            <div class="card-body">
              <table class="table table-bordered">
                <thead class="thead-dark">
                <tr>
                  <th>ID</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Age</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Edit</th>
                  <th>Delete</th>
                </tr>
                </thead>
                <tbody id="usersTableBody">
                <!-- Данные загружаются через JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Форма создания пользователя -->
        <div id="newUser" class="tab-pane fade mt-3 d-flex justify-content-center">
          <div class="card" style="max-width: 400px; width: 100%;">
            <div class="card-header text-center">
              Add New User
            </div>
            <div class="card-body">
              <form id="createUserForm">
                <div class="form-group">
                  <label>First Name:</label>
                  <input type="text" class="form-control" name="firstName" required>
                </div>
                <div class="form-group">
                  <label>Last Name:</label>
                  <input type="text" class="form-control" name="lastName" required>
                </div>
                <div class="form-group">
                  <label>Age:</label>
                  <input type="number" class="form-control" name="age" required>
                </div>
                <div class="form-group">
                  <label>Email:</label>
                  <input type="email" class="form-control" name="email" required>
                </div>
                <div class="form-group">
                  <label>Password:</label>
                  <input type="password" class="form-control" name="password" required>
                </div>
                <div class="form-group">
                  <label>Role:</label>
                  <select class="form-control" name="roles" multiple>
                    <!-- Роли загружаются через JavaScript -->
                  </select>
                </div>
                <div class="text-center">
                  <button type="submit" class="btn btn-success">Add New User</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <!-- модальные окна для Edit и Delete -->
        <!-- Edit Modal -->
        <div class="modal fade" id="editUserModal">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body">
                <form id="editUserForm">
                  <input type="hidden" id="editUserId" name="id">
                  <div class="form-group">
                    <label>First Name:</label>
                    <input type="text" class="form-control" id="editFirstName" name="firstName" required>
                  </div>
                  <div class="form-group">
                    <label>Last Name:</label>
                    <input type="text" class="form-control" id="editLastName" name="lastName" required>
                  </div>
                  <div class="form-group">
                    <label>Age:</label>
                    <input type="number" class="form-control" id="editAge" name="age" required>
                  </div>
                  <div class="form-group">
                    <label>Email:</label>
                    <input type="email" class="form-control" id="editEmail" name="email" required>
                  </div>
                  <div class="form-group">
                    <label>Role:</label>
                    <select class="form-control" id="editRoles" name="roles" multiple></select>
                  </div>
                  <div class="text-center">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Delete Modal -->
        <div class="modal fade" id="deleteUserModal">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <div class="modal-body">
                <form id="deleteUserForm">
                  <input type="hidden" id="deleteUserId">
                  <p>Are you sure you want to delete <span id="deleteFirstName"></span>?</p>
                  <div class="text-center">
                    <button type="submit" class="btn btn-danger">Delete</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
  // Загрузка текущего пользователя
  fetch('/admin/current')
          .then(response => response.json())
          .then(user => {
            document.getElementById('currentUserEmail').textContent = user.email;
            document.getElementById('currentUserRoles').textContent = user.roles.map(role => role.name).join(', ');
          });

  // Загрузка списка пользователей
  fetch('/admin/users')
          .then(response => response.json())
          .then(users => {
            const tbody = document.querySelector('#usersTableBody');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.firstName}</td>
                    <td>${user.lastName}</td>
                    <td>${user.age}</td>
                    <td>${user.email}</td>
                    <td>${user.roles.map(role => role.name).join(', ')}</td>
                    <td><button class="btn btn-info">Edit</button></td>
                    <td><button class="btn btn-danger" onclick="openDeleteModal(${user.id})">Delete</button></td>
                </tr>
            `).join('');
          });

  // Загрузка списка ролей
  fetch('/admin/roles')
          .then(response => response.json())
          .then(roles => {
            const rolesSelect = document.querySelector('#createUserForm select[name="roles"]');
            rolesSelect.innerHTML = roles.map(role => `
                <option value="${role.id}">${role.name}</option>
            `).join('');
          });

  // Создание нового пользователя
  document.getElementById('createUserForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(this);
    const user = {
      firstName: formData.get('firstName'),
      lastName: formData.get('lastName'),
      age: formData.get('age'),
      email: formData.get('email'),
      password: formData.get('password'),
      roles: Array.from(formData.getAll('roles')).map(roleId => ({ id: roleId }))
    };
    fetch('/admin/users', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(user)
    }).then(() => {
      $('#newUser').removeClass('show active'); // Переключаемся обратно на вкладку "Users Table"
      $('.nav-tabs a[href="#usersTable"]').tab('show');
      document.getElementById('createUserForm').reset(); // Очищаем форму
      loadUsers(); // Обновляем таблицу без перезагрузки
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    loadUsers(); // Загружаем пользователей при загрузке страницы
    loadRoles(); // Загружаем роли в форму создания
  });

  // Функция загрузки пользователей

  function loadUsers() {
    fetch('/admin/users')
            .then(response => response.json())
            .then(users => {
              const tbody = document.querySelector('#usersTableBody');
              tbody.innerHTML = ''; // Очищаем таблицу перед обновлением
              users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.firstName}</td>
                    <td>${user.lastName}</td>
                    <td>${user.age}</td>
                    <td>${user.email}</td>
                    <td>${user.roles.map(role => role.name).join(', ')}</td>
                    <td><button class="btn btn-info edit-btn" data-id="${user.id}">Edit</button></td>
                    <td><button class="btn btn-danger delete-btn" data-id="${user.id}">Delete</button></td>
                `;
                tbody.appendChild(row);
              });

              // Добавляем обработчики событий на кнопки
              document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', () => openEditModal(button.dataset.id));
              });

              document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', () => openDeleteModal(button.dataset.id));
              });
            });
  }

  // Функция загрузки ролей в форму добавления
  function loadRoles() {
    fetch('/admin/roles')
            .then(response => response.json())
            .then(roles => {
              const rolesSelect = document.querySelector('#createUserForm select[name="roles"]');
              rolesSelect.innerHTML = roles.map(role => `<option value="${role.id}">${role.name}</option>`).join('');
            });
  }

  // Функция открытия модального окна редактирования
  function openEditModal(userId) {
    fetch(`/admin/users/${userId}`)
            .then(response => response.json())
            .then(user => {
              document.querySelector('#editUserId').value = user.id;
              document.querySelector('#editFirstName').value = user.firstName;
              document.querySelector('#editLastName').value = user.lastName;
              document.querySelector('#editAge').value = user.age;
              document.querySelector('#editEmail').value = user.email;

              const rolesSelect = document.querySelector('#editRoles');
              rolesSelect.innerHTML = ''; // Очищаем перед обновлением

              fetch('/admin/roles')
                      .then(response => response.json())
                      .then(roles => {
                        roles.forEach(role => {
                          const option = document.createElement('option');
                          option.value = role.id;
                          option.textContent = role.name;
                          if (user.roles.some(r => r.id === role.id)) {
                            option.selected = true;
                          }
                          rolesSelect.appendChild(option);
                        });
                      });

              $('#editUserModal').modal('show'); // Открываем модальное окно
            })
            .catch(error => console.error('Ошибка загрузки пользователя:', error));
  }

  // Функция отправки обновленных данных пользователя
  document.querySelector('#editUserForm').addEventListener('submit', function (event) {
    event.preventDefault(); // Отменяем стандартное поведение формы

    const userId = document.querySelector('#editUserId').value;
    const updatedUser = {
      id: userId,
      firstName: document.querySelector('#editFirstName').value,
      lastName: document.querySelector('#editLastName').value,
      age: document.querySelector('#editAge').value,
      email: document.querySelector('#editEmail').value,
      roles: Array.from(document.querySelector('#editRoles').selectedOptions).map(option => ({
        id: option.value,
        name: option.textContent
      }))
    };

    fetch(`/admin/users/${userId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(updatedUser)
    })
            .then(response => {
              if (!response.ok) {
                throw new Error('Ошибка при обновлении пользователя');
              }
              return response.json();
            })
            .then(() => {
              $('#editUserModal').modal('hide'); // Закрываем модалку
              loadUsers(); // Перезагружаем данные (можно заменить на обновление таблицы без перезагрузки)
            })
            .catch(error => console.error('Ошибка обновления пользователя:', error));
  });

  // Привязываем обработчики к кнопкам редактирования
  document.querySelectorAll('.edit-btn').forEach(button => {
    button.addEventListener('click', function () {
      const userId = this.getAttribute('data-id');
      openEditModal(userId);
    });
  });



  // Функция открытия модального окна удаления
  function openDeleteModal(userId) {
    fetch(`/admin/users/${userId}`)
            .then(response => response.json())
            .then(user => {
              document.querySelector('#deleteUserId').value = user.id;
              document.querySelector('#deleteFirstName').value = user.firstName;
              // document.querySelector('#deleteLastName').value = user.lastName;
              // document.querySelector('#deleteAge').value = user.age;
              // document.querySelector('#deleteEmail').value = user.email;
              $('#deleteUserModal').modal('show'); // Открываем модальное окно
            });
  }

  // Функция удаления пользователя
  document.querySelector('#deleteUserForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const userId = document.querySelector('#deleteUserId').value;

    fetch(`/admin/users/${userId}`, { method: 'DELETE' })
            .then(() => {
              $('#deleteUserModal').modal('hide'); // Закрываем модальное окно
              loadUsers(); // Обновляем таблицу
            });
  });

</script>

</body>
</html>
